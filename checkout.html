<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagar con ATH Móvil</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="checkout-container">
        <img src="athm-circle-logo.svg" alt="Logo ATH Móvil" class="logo">
        <h1>Confirmar Pago</h1>
        <p id="amount-text">Cantidad a pagar: $0.00</p>
        <div id="ATHMovil_Checkout_Button_payment"></div>
        <p id="status-message"></p>
    </div>

    <script src="https://payments.athmovil.com/api/js/athmovil_base.js"></script>
    <script>
        // Obtener la cantidad desde la URL
        const urlParams = new URLSearchParams(window.location.search);
        const amount = parseFloat(urlParams.get('amount')).toFixed(2);

        // Mostrar la cantidad en la interfaz
        document.getElementById('amount-text').innerText = `Cantidad a pagar: $${amount}`;

        // Configurar el pago en ATH Móvil
        const ATHM_Checkout = {
            env: 'production',
            publicToken: 'a66ce73d04f2087615f6320b724defc5b4eedc55',  // Token de tu cuenta de negocio
            timeout: 600,
            theme: 'btn',
            lang: 'es',
            total: amount,  // Monto total a pagar
            tax: 0.00,
            subtotal: amount,
            metadata1: 'ID de Tienda',
            metadata2: 'Localización',
            items: [
                {
                    "name": "Servicio",
                    "description": "Pago de servicio",
                    "quantity": "1",
                    "price": amount.toFixed(2),
                    "tax": "0",
                    "metadata": "Pago del servicio"
                }
            ],
            phoneNumber: "7872439670"  // Teléfono del negocio que recibirá el pago
        };

        // Función para consultar el estado del pago
        async function checkPaymentStatus(referenceNumber) {
            try {
                const response = await fetch(`/api/check-payment?reference=${referenceNumber}`);
                const result = await response.json();
                
                if (result.status === 'completed') {
                    window.location.href = "/success.html";
                } else {
                    document.getElementById('status-message').innerText = 'Esperando confirmación del pago...';
                    setTimeout(() => checkPaymentStatus(referenceNumber), 3000); // Reintentar cada 3 segundos
                }
            } catch (error) {
                console.error('Error al verificar el estado del pago:', error);
            }
        }

        // Callback: Pago autorizado
        async function authorizationATHM(referenceNumber) {
            console.log('Pago autorizado.');
            document.getElementById('status-message').innerText = 'Pago autorizado. Esperando confirmación...';
            checkPaymentStatus(referenceNumber);
        }

        // Callback: Pago cancelado
        async function cancelATHM() {
            console.log('Pago cancelado.');
            document.getElementById('status-message').innerText = 'El pago fue cancelado.';
        }

        // Callback: Pago expirado
        async function expiredATHM() {
            console.log('Pago expirado.');
            document.getElementById('status-message').innerText = 'El pago ha expirado.';
        }
    </script>
</body>
</html>
